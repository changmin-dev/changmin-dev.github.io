## AWS를 이용한 배포  

플라스크 run()함수를 호출시 호스트를 0.0.0.0으로 해야 외부에서 접근이 가능하다. 사실 이것때문에 사용하던 Azure Web App에서 접근이 안되는거 일 수도 있겠는데 확인해봐야겠다. 지금 하는 프로젝트가 포트폴리오용으로 바뀐다면 그쪽으로 보내주는게 좋겠다.

특 정 계정 그룹 확인 하기
groups [계정명]
그룹 추가
gpasswd -a [그룹명] [계정명]
그룹 삭제
gpasswd -d [그룹명] [계정명]
http://withcoding.com/102
pem.key로 관리 하기
http://lifeignite.tistory.com/17
## 토큰을 이용한 인증하기 
API를 호출을 위해서는 토큰을 이용하는 인증 방식을 사용하기로 했다.
[생활 코딩](https://opentutorials.org/course/2473/16571)그리고 [이곳](https://velopert.com/2350)을 통해서 어떻게 하는지 감을 잡았다.
우리 팀에서 만드는 로그인은 이렇다. 앱에서 위탁한 곳(페이스북 같은 로그인 API제공 하는 곳)에서 로그인 처리를 하면, 토큰을 발급받게 되는데 이것을 서버로 전달한다.
서버에서는 전달 받은 토큰으로 유저 정보를 얻는다. 
사실 좀 비효율 적이라고 느꼈는데 앱에서 토큰으로 유저 정보(이메일, 이름, 프로필 사진)을 받아서 전달 하는게 좀 더 낫지 않냐는 생각이다. 하지만 그렇게 하면, 인터페이스의 일관성이 무너질 수가 있다고 설득을 당해서 이렇게 했다. 토큰을 중간에서 가로채기 당하면 그래프 API로 정보를 얻을 수 있어서 위험하지만, 이메일이 바로 노출되는거 보다는 나은거 같기도 하다.
이런 문제를 방지하기 위해 APP_ID와 APP_SECRET을 파일에 저장 해서 불러오기로 했다. 이 방법에 대해서는 [잘 정리된 글](https://mingrammer.com/ways-to-manage-the-configuration-in-python/)을 발견해서 쉽게 해결했다. 나 같은 경우는 `.ini`파일에 저장 하는 방식으로 했다. 파일에 저장하는 법 말고 다른 방법이 있었지만 명절이 시작하기 전에 API를 제공해주어야 해서 가장 쉽고 방법을 선택했다.
`.ini`는 게임할때 설정값 바꿀때 많이 쓰는 포맷이라 익숙했다. `.json`은 나의 경우 복잡하게 계층적으로 할 필요가 없고 따옴표를 계속 써줘야 하는게 마음에 안들었다.
유저 정보를 얻기 위해서는 페이스북의 API를 사용해야 했는데 공식적으로 제공하는 파이썬용 SDK가 없었다. 웹용으로 제공되는 것을 응용해서 하려고 했는데 구글과는 달리 별도의 SDK를 제공해서 내부를 볼 수 없거나 보는데 오래 걸릴꺼 같아서 flask-oauthlib이라는 패키지를 사용하기로 했다. 페이스북 말고도 페이스북 예제를 참고 해서 구현 했다. 예제가 웹페이지에서 사용하는 예제라서 고칠 필요가 있었는데 사용하는 함수만 보면 직접 구현 할수도 있을꺼 같고 `tokengetter`라는 것을 사용하는데 왜 이렇게 하는지는 모르겠다. 나중에 가능하다면 없애고 직접 이부분만 구현하려고 한다. 

서버에서는 유저 정보를 얻으면 등록된 유저인지 확인하고 등록이 되었다면 엑세스 토큰과 리프레쉬 토큰을 제공한다. 등록이 안되었다면 등록하고 마찬가지로 토큰을 제공한다.
토큰의 경우는 JWT(https://jwt.io/)를 사용하기로 하고(별도의 규칙으로 만드는거 보다는 잘 알려진 것을 사용하는게 좋다고 판단) flask_jwt_extended이라는 패키지가 너무 잘되어 있어서 사용했다.

## SQLAchemy - 기억이 안나!!!
ORM을 쓰는게 편해서 사용하려고 한다. 분명히 ORM은 처음에 적응하기 어렵다.(Entity framework의 악몽) SQL이랑 멀어 질수 있지만, 사용하는게 간단한 CRUD라면 나쁘지 않다고 생각한다. 지금은 MySQL을 사용하고 있는데 복잡한 스키마도 아니고 프로젝트를 포트폴리오로 유지만 한다면 SQLite로 바꾸는 것을 고려 하고 있다. DB가 바뀌어도 크게 로직의 수정이 없는 것도 ORM의 장점 인거 같다.
처음에 SQLAchemy를 설치하고 사용하는데 DB에서 연결 거부 당했다고 나왔다. 같은 인증 정보로 MySQL워크벤치에서 접속했는데 잘됬다.
Flask-SQLAchemy라는 친구가 있는데 사실 이런거 까지 쓰기는 싫어서 않썼는데 혹시 된다면 사용하는게 좋을꺼 같아서 사용 했다. 다행이 커넥션은 성공한거 같지만 DB에 반영이 안되고 있었다.

문제는 여기서 발생했던 것이다. 파일명이 pymysql이라서 모듈을 못가지고 오고 있었다.

pymysql에서 AttributeError: 'builtin_function_or_method' object has no attribute 'translate'
라는 에러가 떴는데  시간을 가지는 칼럼이 있는데 datetime.utcnow라고 값을 입력해서 문제가 발생했다. ()괄호를 뒤에 붙이지 않아서 문제가 된거 같다. 모델 선언시에는 괄호를 쓰지 않아서 똑같이 해줬더니 문제가 발생했다.
처음에는 
업데이트 문제 app.config["SQLALCHEMY_COMMIT_ON_TEARDOWN"] = True 임시로 해결함
 삭제 안되는 문제 select, delete하는 세션이 달라서 였음 세션을 복사해서 성공

 ## Custom JSONEnocoder
 json

## nginx
플라크스는 WAS의 기능을 수행한다.(DB에서 정보를 받아서 가공해서 제공, 템플릿 엔진 등으로 동적인 html페이지 제공) 플라스크는 WSGI를 만족하므로 웹서비스를 제공할수 있따. 그렇다면 웹서버를 사용해야하는 이유가 무엇인가? WAS가 동적인 정보를 제공한다면, 웹서버는 정적인 정보를 제공한다.(HTML, css 등) [자바 진영의 톰캣은 5.5부터 Httpd의 native 모듈을 사용해서 스태틱 파일을 처리하는 기능을 제공한다.(무려 2010년도 글이다.)](http://toby.epril.com/?p=1125)

## 고려한 친구들
fabric 원격 배포 도구 - 쉘이 있는데 굳이 써야하나

## 배포
쉘 스크립트가 있는데 코딱지만한 프로젝트에서 fabric 같은 도구가 있지만 솔직히 쓸 필요가 있나 싶다.
그리 익숙하지는 않지만 설치 없이 사용하기 좋다.
명령어만 하는 방식은 느린건지 잘 모르겠다.
이거는 실행이 안되는거 같은데 echo만 나오는 듯
```
ssh -i 인증키
bash deploy.sh
ssh -i 인증키 'bash deploy.sh' 이상하게 ssh연결이 끝나지 않지만 정상 작동되는 걸로 추정(로그로 확인)
```

접속하고 run 실행이 꿀이긴하지

비공개 레포라면 로그 정보를 저장 해야함
git config credential.helper store

## 로깅
http://www.jinniahn.com/2016/10/python-logger.html



## 관계가 있는 테이블을 삭제할때
1 : 다 관계에서 1의 테이블이 참조되는 상황이코 1을 삭제려는 경우에 문제가 발생했다. 
cascade를 이용한다. 
다음과 같이 삭제 할 모듈에 정의한다.
변수 = db.relationship("삭제할 모델을 참조하는  클래스 이름", cascade="all, delete-orphan")
http://docs.sqlalchemy.org/en/latest/orm/cascades.html