---
layout: post
title: JNI와 javah
---

예전에 JNI가 필요해서 사용한 적이 있었는데 하나 하나 타이핑 했었다. 하지만 javah라는 도구로 생성 할 수 있다는 것을 알게되어서 정리하려고 한다. 지금은 단순한 것을 하지만 의미 있는 것을 위한 준비 단계라고 생각해야 겠다.

## Java Native Interface
자바에서 Method를 다른 프로그래밍 언어로 구현하는 것을 말한다. 성능 향상이나 하드웨어 제어같은 목적을 위해서 사용한다.

## native 키워드와 System.loadLibrary()
`native` 키워드가 사용된다. 이 메소드가 구현된 라이브러리를 불러오기 위해서 `System.loadLibrary()`함수를 사용한다.

## java 구현 코드
아래와 같은 자바 코드에 대해서 
```java
public class NativeMethodTest{
    public native void printInt(int val);
    public static void main(String[] args){
        System.loadLibrary("NativeMethodTest");
        new NativeMethodTest().printInt(526);
    }
}
```

## javah 사용
먼저 컴파일을 하고 javah를 사용한다. javah는 `.class`파일을 이용해서 헤더파일을 만들어 낸다.
```
javac NativeMethodTest
javah NativeMethod
```

## javah가 만들어낸 파일
C의 함수에 대한 헤더파일을 만들어 준다. 
```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class NativeMethodTest */

#ifndef _Included_NativeMethodTest
#define _Included_NativeMethodTest
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     NativeMethodTest
 * Method:    printInt
 * Signature: (I)V
 */
JNIEXPORT void JNICALL Java_NativeMethodTest_printInt
  (JNIEnv *, jobject, jint);

#ifdef __cplusplus
}
#endif
#endif
```

## Header파일에 대한 구현
헤더파일은 생성되지만 구현은 직접해야한다.
```c
#include "NativeMethodTest.h"
#include <stdio.h>

JNIEXPORT void JNICALL Java_NativeMethodTest_printInt
(JNIEnv *env, jobject obj, jint value){
    printf("In the native method, ");
    printf("NativeMethodTest.printInt(iVal = %d\n)", value);
}
```

## 컴파일 및 라이브러리(.dylib) 링크 생성(OSX)
지금은 환경이 맥이라서 OS X기준으로 .dylib을 생성한다. 윈도우라면 .dll 리눅스라면 .so일 것이다. 이때 라이브러리 파일명은 파일명 앞에 lib가 붙어야한다. 아까 파일명이 NativeMethodTest였으니 libNativeMethodTest.dylib이다. 
```
cc -g -shared -fpic -I/{jni.h파일의 위치} NativeMethodTest.c -I/{jni_md.h파일의 위치} -o lib{헤더파일 명}.확장자
```

## 실행하기
자바에게 라이브러리 위치를 알려 주어야한다.
```
java -Djava.library.path={라이브러리 위치} NativeMethodTest
```

## 참고
자바 입문(책)  
[http://jnicookbook.owsiak.org/recipe-No-001/](http://jnicookbook.owsiak.org/recipe-No-001/)
