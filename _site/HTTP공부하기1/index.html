<!DOCTYPE html>
<html>
  <head>
    <title>HTTP 공부하기 1 – Twibeat – 잊어 버리지 않기 위해서</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="HTTP 공부하기
“소켓으로 HTTP 요청하는 걸 해볼 수 있을까?”라는 생각으로 시도하다가 못하고 있었는데 좋은 학습용 자료를 찾은 거 같다. 분명 글로만 알고 있는 것보다. 도움이 될 것이다. 
HTTP 이해
동영상

" />
    <meta property="og:description" content="HTTP 공부하기
“소켓으로 HTTP 요청하는 걸 해볼 수 있을까?”라는 생각으로 시도하다가 못하고 있었는데 좋은 학습용 자료를 찾은 거 같다. 분명 글로만 알고 있는 것보다. 도움이 될 것이다. 
HTTP 이해
동영상

" />
    
    <meta name="author" content="Twibeat" />

    
    <meta property="og:title" content="HTTP 공부하기 1" />
    <meta property="twitter:title" content="HTTP 공부하기 1" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Twibeat - 잊어 버리지 않기 위해서" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://github.com/identicons/twibeat.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Twibeat</a></h1>
            <p class="site-description">잊어 버리지 않기 위해서</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>HTTP 공부하기 1</h1>

  <div class="entry">
    <h1 id="http-공부하기">HTTP 공부하기</h1>
<p>“소켓으로 HTTP 요청하는 걸 해볼 수 있을까?”라는 생각으로 시도하다가 못하고 있었는데 좋은 학습용 자료를 찾은 거 같다. 분명 글로만 알고 있는 것보다. 도움이 될 것이다. 
<a href="https://www.slideshare.net/javajigi/http-web-server">HTTP 이해</a><br />
<a href="https://www.youtube.com/watch?v=qgFVj916nX8&amp;list=PLqaSEyuwXkSqV88SwDxuY56xmj6KsmzRN&amp;index=1">동영상</a></p>

<h2 id="소켓-연결">소켓 연결</h2>
<p>서버 소켓을 만들어서 대기하고 있다가. 요청이 들어 오면 소켓을 만들어서 통신한다. RequestHandler객체를 만들어서 start()한다. 이는 run()메소드 내용을 실행한다는 뜻이고, RequestHandler는 Thread를 상속받는는 것을 의미한다.</p>

<h3 id="requesthandler에서-indexhtml페이지-출력하기">RequestHandler에서 index.html페이지 출력하기</h3>
<p>요구 사항은 index.html파일을 읽어서 Byte로 출력하는 것이다.<br />
나는 처음에 이런 방식으로 했다. (힌트가 있었지만 안보고 내 생각대로 했다.)</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">BufferedInputStream</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">"webapp/index.html"</span><span class="o">));</span>
<span class="n">StringBuilder</span> <span class="n">bodyString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
<span class="k">while</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">available</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
    <span class="n">bodyString</span><span class="o">.</span><span class="na">append</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span><span class="n">buffer</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
<span class="o">}</span>
<span class="n">buffer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">bodyString</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">();</span>
</code></pre>
</div>
<p>하지만 한글 인코딩이 깨지는 문제가 있었다.(원래는 바이트로 받아 오려고 무모한 도전을 했었다.)
어짜피 스트링을 사용한다면, InputStreamReader를 사용해서 스트링 자체를 가져온다면 괜찮지 않을까?</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">StringBuilder</span> <span class="n">bodyString</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
<span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="s">"webapp/index.html"</span><span class="o">);</span>
<span class="n">String</span> <span class="n">data</span><span class="o">;</span>
<span class="k">while</span><span class="o">((</span><span class="n">data</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
    <span class="n">bodyString</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">br</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">bodyString</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">();</span>
</code></pre>
</div>
<p>아쉽지만 한줄로 가능했다. <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/file/Files.html">java.io.Files</a>를 이용하면 된다.</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"./webapp/index.html"</span> <span class="o">).</span><span class="na">toPath</span><span class="o">());</span>
</code></pre>
</div>
<h3 id="request-header에서-경로-받아오기">Request Header에서 경로 받아오기</h3>
<p><code class="highlighter-rouge">GET / HTTP1.1</code>처음에 이렇게 요청이 올 것이다. 한 줄을 읽어서 URI정보를 얻을 수 있다.</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span><span class="c1">//connection은 소켓 객체이다.</span>
<span class="n">BufferedReader</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">));</span>
<span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span> 
<span class="k">if</span><span class="o">(</span><span class="n">line</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">String</span><span class="o">[]</span> <span class="n">splited</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>

<span class="k">if</span><span class="o">(</span><span class="n">splited</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">3</span><span class="o">){</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"HTTP Request Error"</span><span class="o">);</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">String</span> <span class="n">URI</span> <span class="o">=</span> <span class="n">splited</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>

<span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">"./webapp"</span> <span class="o">+</span> <span class="n">URI</span><span class="o">).</span><span class="na">toPath</span><span class="o">());</span> 
</code></pre>
</div>

<h3 id="get으로-회원가입유저-객체-생성">GET으로 회원가입(유저 객체 생성)</h3>
<p>GET요청으로 회원 가입하는 것을 구현 하라고 한다. split의 입력은 정규 표현식이므로 ?같은 문자를 사용하려면 대괄호를 사용해야한다.</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">if</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/create?"</span><span class="o">)){</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"?"</span><span class="o">);</span>

    <span class="n">String</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">"[&amp;]"</span><span class="o">);</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
    <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">parameter</span> <span class="o">:</span> <span class="n">parameters</span><span class="o">){</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">keyValue</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"="</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">keyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">keyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
    <span class="o">}</span>

    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"userId"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"password"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">));</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">URI</span> <span class="o">=</span> <span class="s">"/index.html"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>
<h3 id="post로-회원-가입">POST로 회원 가입</h3>
<p>실제로는 GET으로 회원가입을 하지않는다. POST를 보통 사용한다. POST를 사용하는 경우는 Header와 Body로 분리 된다는 것을 기억해야한다. 헤더와 바디는 줄바꿈으로 나누어진다. form으로 POST요청한 경우는 GET에서 주소로 받은 쿼리가 Body에 있다. 로그를 찍어보면 한번 요청을 보내면 여러 요청이 가는데 form.html에서 link되어있는 css였다.</p>

<h4 id="헤더-처리-하기">헤더 처리 하기</h4>
<p>헤더에서 필요한것은 Content-Length이다.</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">contentLength</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">while</span><span class="o">(!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">line</span><span class="o">)){</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">keyValue</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">": "</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">keyValue</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">2</span><span class="o">){</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">keyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">keyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"{} : {}"</span><span class="o">,</span> <span class="n">keyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">keyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="k">if</span><span class="o">(</span><span class="n">headers</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"Content-Length"</span><span class="o">))</span>
    <span class="n">contentLength</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">headers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"Content-Length"</span><span class="o">));</span>
</code></pre>
</div>

<h4 id="요청하기">요청하기</h4>
<p>POST에서 달라진 것은 contentLength만큼 데이터를 받는다는 것이다.</p>
<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">if</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"/create"</span><span class="o">)){</span>
    <span class="kt">char</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[</span><span class="n">contentLength</span><span class="o">];</span>
    <span class="n">br</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">contentLength</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">copyValueOf</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="n">String</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">requestBody</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"[&amp;]"</span><span class="o">);</span> 

    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
    <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">parameter</span> <span class="o">:</span> <span class="n">parameters</span><span class="o">){</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">keyValue</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"="</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">keyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">keyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
    <span class="o">}</span>

    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"userId"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"password"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"email"</span><span class="o">));</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">URI</span> <span class="o">=</span> <span class="s">"/index.html"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

  </div>

  <div class="date">
    Written on September 24, 2017
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/twibeat"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/twibeat22"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
